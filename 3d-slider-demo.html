<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Slider Demo - KUV плагины</title>
    
    <!-- IMPORTANT: Load Swiper CSS first -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    
    <style>
      /* ... previous styles remain the same ... */
      .swiper {
        width: 100%;
        height: 500px;
      }
      
      .swiper-slide {
        text-align: center;
        background: #444;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      
      .three-scene {
        width: 100%;
        height: 100%;
      }
      
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <header>
      <!-- ... header content remains the same ... -->
    </header>

    <main>
      <h1>3D Slider Demo</h1>
      
      <!-- ВАЖНО: Изменена структура слайдера -->
      <div class="swiper">
        <div class="swiper-wrapper">
          <div class="swiper-slide">
            <div class="three-scene" id="scene1"></div>
          </div>
          <div class="swiper-slide">
            <div class="three-scene" id="scene2"></div>
          </div>
          <div class="swiper-slide">
            <div class="three-scene" id="scene3"></div>
          </div>
        </div>
        <div class="swiper-pagination"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-button-next"></div>
      </div>

      <!-- ... rest of the content remains the same ... -->
    </main>

    <footer>
      <!-- ... footer content remains the same ... -->
    </footer>

    <!-- IMPORTANT: Load scripts in this specific order -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    
    <script>
      // Wait for DOM content to load
      window.addEventListener('DOMContentLoaded', function() {
        // Initialize Swiper first
        const swiper = new Swiper('.swiper', {
          // Optional parameters
          direction: 'horizontal',
          loop: true,
          
          // If we need pagination
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },

          // Navigation arrows
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });

        // Array to store our scenes
        const scenes = [];
        
        // Function to create different geometries
        function createGeometry(index) {
          switch(index) {
            case 0:
              return new THREE.BoxGeometry(1, 1, 1); // Куб
            case 1:
              return new THREE.SphereGeometry(1, 32, 32); // Сфера
            case 2:
              return new THREE.TorusGeometry(1, 0.4, 16, 100); // Тор
            default:
              return new THREE.BoxGeometry(1, 1, 1);
          }
        }

        // Setup each scene
        document.querySelectorAll('.three-scene').forEach((element, index) => {
          // Create scene
          const scene = new THREE.Scene();
          
          // Setup camera
          const camera = new THREE.PerspectiveCamera(
            75,
            element.clientWidth / element.clientHeight,
            0.1,
            1000
          );
          camera.position.z = 5;

          // Setup renderer
          const renderer = new THREE.WebGLRenderer({ 
            antialias: true,
            alpha: true 
          });
          renderer.setSize(element.clientWidth, element.clientHeight);
          renderer.setPixelRatio(window.devicePixelRatio);
          element.appendChild(renderer.domElement);

          // Create mesh
          const geometry = createGeometry(index);
          const material = new THREE.MeshPhongMaterial({
            color: 0x31baeb,
            shininess: 100,
            specular: 0x31baeb
          });
          const mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);

          // Add lights
          const light1 = new THREE.DirectionalLight(0xffffff, 1);
          light1.position.set(1, 1, 1);
          scene.add(light1);

          const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
          light2.position.set(-1, -1, -1);
          scene.add(light2);

          const ambientLight = new THREE.AmbientLight(0x404040);
          scene.add(ambientLight);

          // Create scene object
          const sceneObj = {
            scene,
            camera,
            renderer,
            mesh,
            element,
            animate: function() {
              if (!document.hidden && swiper.activeIndex === index) {
                this.mesh.rotation.x += 0.01;
                this.mesh.rotation.y += 0.01;
                this.renderer.render(this.scene, this.camera);
              }
              requestAnimationFrame(() => this.animate());
            },
            resize: function() {
              const width = this.element.clientWidth;
              const height = this.element.clientHeight;
              
              this.camera.aspect = width / height;
              this.camera.updateProjectionMatrix();
              this.renderer.setSize(width, height);
            }
          };

          scenes.push(sceneObj);
          sceneObj.animate();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
          scenes.forEach(scene => scene.resize());
        });

        // Handle visibility changes
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            scenes.forEach(scene => scene.resize());
          }
        });
      });
    </script>
  </body>
</html>
