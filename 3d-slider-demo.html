<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Models Slider - KUV плагины</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" />
    
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #1a1a1a;
        color: #fff;
        font-family: Arial, sans-serif;
      }

      .swiper {
        width: 100%;
        height: 80vh;
      }
      
      .swiper-slide {
        background: #1a1a1a;
      }
      
      .three-scene {
        width: 100%;
        height: 100%;
      }

      .swiper-button-next,
      .swiper-button-prev {
        color: #31baeb;
      }

      .swiper-pagination-bullet {
        background: #31baeb;
      }

      .swiper-pagination-bullet-active {
        background: #31baeb;
      }
      
      .loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        z-index: 1000;
      }

      .loading-text {
        margin-bottom: 20px;
        font-size: 1.2em;
      }

      .progress-bar {
        width: 200px;
        height: 4px;
        background: #333;
        border-radius: 2px;
        overflow: hidden;
      }

      .progress {
        width: 0%;
        height: 100%;
        background: #31baeb;
        transition: width 0.3s ease;
      }

      .model-info {
        position: absolute;
        bottom: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 5px;
        z-index: 1;
      }

      .model-info h3 {
        margin: 0;
        font-size: 1.2em;
        color: #31baeb;
      }

      .model-info p {
        margin: 5px 0 0;
        font-size: 0.9em;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <div class="loading-screen">
      <div class="loading-text">Загрузка моделей...</div>
      <div class="progress-bar">
        <div class="progress"></div>
      </div>
    </div>

    <div class="swiper">
      <div class="swiper-wrapper">
        <div class="swiper-slide">
          <div class="three-scene" id="scene1"></div>
          <div class="model-info">
            <h3>Duck</h3>
            <p>Классическая тестовая модель</p>
          </div>
        </div>
        <div class="swiper-slide">
          <div class="three-scene" id="scene2"></div>
          <div class="model-info">
            <h3>Damaged Helmet</h3>
            <p>Модель с PBR материалами</p>
          </div>
        </div>
        <div class="swiper-slide">
          <div class="three-scene" id="scene3"></div>
          <div class="model-info">
            <h3>Flight Helmet</h3>
            <p>Сложная модель с текстурами</p>
          </div>
        </div>
      </div>
      <div class="swiper-pagination"></div>
      <div class="swiper-button-prev"></div>
      <div class="swiper-button-next"></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const loadingScreen = document.querySelector('.loading-screen');
        const progressBar = document.querySelector('.progress');
        const loadingText = document.querySelector('.loading-text');

        // Инициализация Swiper
        const swiper = new Swiper('.swiper', {
          loop: true,
          speed: 1000,
          spaceBetween: 30,
          effect: 'fade',
          fadeEffect: {
            crossFade: true
          },
          pagination: {
            el: '.swiper-pagination',
            clickable: true,
          },
          navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
          },
        });

        // Массив для хранения сцен
        const scenes = [];
        const totalModels = 3;
        let loadedModels = 0;

        // Массив моделей
        const models = [
          {
            url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf',
            scale: 2,
            position: { x: 0, y: 0, z: 0 },
            rotation: { x: 0, y: 0, z: 0 }
          },
          {
            url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/DamagedHelmet/glTF/DamagedHelmet.gltf',
            scale: 2,
            position: { x: 0, y: 0, z: 0 },
            rotation: { x: 0, y: 0, z: 0 }
          },
          {
            url: 'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/FlightHelmet/glTF/FlightHelmet.gltf',
            scale: 3,
            position: { x: 0, y: -1, z: 0 },
            rotation: { x: 0, y: 0, z: 0 }
          }
        ];

        // Создаем сцены
        document.querySelectorAll('.three-scene').forEach((element, index) => {
          const scene = new THREE.Scene();
          scene.background = new THREE.Color(0x1a1a1a);
          
          const camera = new THREE.PerspectiveCamera(
            45,
            element.clientWidth / element.clientHeight,
            0.1,
            1000
          );
          camera.position.set(0, 0, 5);

          const renderer = new THREE.WebGLRenderer({ 
            antialias: true 
          });
          renderer.setSize(element.clientWidth, element.clientHeight);
          renderer.setPixelRatio(window.devicePixelRatio);
          renderer.outputEncoding = THREE.sRGBEncoding;
          renderer.toneMapping = THREE.ACESFilmicToneMapping;
          element.appendChild(renderer.domElement);

          // Освещение
          const light1 = new THREE.DirectionalLight(0xffffff, 1);
          light1.position.set(1, 1, 1);
          scene.add(light1);

          const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
          light2.position.set(-1, -1, -1);
          scene.add(light2);

          const ambientLight = new THREE.AmbientLight(0x404040, 2);
          scene.add(ambientLight);

          // Контролы
          const controls = new THREE.OrbitControls(camera, renderer.domElement);
          controls.enableDamping = true;
          controls.dampingFactor = 0.05;
          controls.screenSpacePanning = false;
          controls.minDistance = 2;
          controls.maxDistance = 10;
          controls.maxPolarAngle = Math.PI / 1.5;

          // Загрузка модели
          const loader = new THREE.GLTFLoader();
          
          loader.load(
            models[index].url,
            function(gltf) {
              const model = gltf.scene;
              scene.add(model);

              // Центрируем и масштабируем модель
              const box = new THREE.Box3().setFromObject(model);
              const center = box.getCenter(new THREE.Vector3());
              const size = box.getSize(new THREE.Vector3());
              
              const maxDim = Math.max(size.x, size.y, size.z);
              const scale = models[index].scale / maxDim;
              model.scale.multiplyScalar(scale);
              
              model.position.sub(center.multiplyScalar(scale));
              model.position.add(new THREE.Vector3(
                models[index].position.x,
                models[index].position.y,
                models[index].position.z
              ));

              loadedModels++;
              progressBar.style.width = (loadedModels / totalModels * 100) + '%';
              
              if (loadedModels === totalModels) {
                loadingScreen.style.display = 'none';
              }

              // Создаем объект сцены
              const sceneObj = {
                scene,
                camera,
                renderer,
                controls,
                model,
                animate: function() {
                  if (!document.hidden && swiper.activeIndex === index) {
                    this.model.rotation.y += 0.005;
                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                  }
                }
              };

              scenes.push(sceneObj);
            },
            function(xhr) {
              // Прогресс загрузки для каждой модели
              const modelProgress = xhr.loaded / xhr.total;
              const totalProgress = ((loadedModels + modelProgress) / totalModels * 100).toFixed(0);
              loadingText.textContent = `Загрузка моделей... ${totalProgress}%`;
            },
            function(error) {
              console.error('Ошибка загрузки модели:', error);
              loadedModels++;
              if (loadedModels === totalModels) {
                loadingScreen.style.display = 'none';
              }
            }
          );
        });

        // Анимационный цикл
        function animate() {
          requestAnimationFrame(animate);
          scenes.forEach(scene => scene.animate());
        }
        animate();

        // Обработка изменения размера окна
        window.addEventListener('resize', function() {
          scenes.forEach(scene => {
            const element = scene.renderer.domElement.parentElement;
            const width = element.clientWidth;
            const height = element.clientHeight;
            
            scene.camera.aspect = width / height;
            scene.camera.updateProjectionMatrix();
            scene.renderer.setSize(width, height);
          });
        });

        // Обработка видимости вкладки
        document.addEventListener('visibilitychange', () => {
          if (!document.hidden) {
            scenes.forEach(scene => {
              scene.controls.update();
              scene.renderer.render(scene.scene, scene.camera);
            });
          }
        });
      });
    </script>
  </body>
</html>